{% extends 'base/layout.html' %}
{% load static %}

{% block title %}Network Canvas Dashboard{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'netbox_network_canvas_plugin/topology.css' %}">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>Network Canvas Dashboard</h1>
                <p class="text-muted">Interactive Layer 2 and Layer 3 network topology visualization</p>
            </div>
            <div>
                <a href="{% url 'plugins:netbox_network_canvas_plugin:networktopologycanvas_list' %}" class="btn btn-outline-primary">
                    <i class="mdi mdi-view-list"></i> View All Canvases
                </a>
                <a href="{% url 'plugins:netbox_network_canvas_plugin:networktopologycanvas_add' %}" class="btn btn-success">
                    <i class="mdi mdi-plus"></i> Create Canvas
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Network Statistics -->
<div class="topology-stats">
    <div class="row">
        <div class="col-md-3">
            <div class="stat-item">
                <span class="stat-number">{{ device_count }}</span>
                <span class="stat-label">Devices</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-item">
                <span class="stat-number">{{ canvas_count }}</span>
                <span class="stat-label">Canvas Views</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-item">
                <span class="stat-number">{{ vlan_count }}</span>
                <span class="stat-label">VLANs</span>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-item">
                <span class="stat-number">{{ cable_count }}</span>
                <span class="stat-label">Connections</span>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title mb-0">Live Network Topology</h5>
                        <small class="text-muted">Interactive visualization of your network infrastructure</small>
                    </div>
                    <div class="d-flex gap-3">
                        <!-- Controls -->
                        <div class="topology-controls">
                            <button id="refresh-btn" class="btn btn-primary btn-sm">
                                <i class="mdi mdi-refresh"></i>
                            </button>
                            <button id="zoom-fit-btn" class="btn btn-outline-secondary btn-sm" title="Fit to Screen">
                                <i class="mdi mdi-fit-to-page"></i>
                            </button>
                            <button id="toggle-labels-btn" class="btn btn-outline-secondary btn-sm" title="Toggle Labels">
                                <i class="mdi mdi-label"></i>
                            </button>
                            <button id="zoom-in-btn" class="btn btn-outline-secondary btn-sm" title="Zoom In">
                                <i class="mdi mdi-magnify-plus"></i>
                            </button>
                            <button id="zoom-out-btn" class="btn btn-outline-secondary btn-sm" title="Zoom Out">
                                <i class="mdi mdi-magnify-minus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="topology-container" class="topology-container" style="width: 100%; height: 600px; position: relative;">
                    <div id="loading" class="topology-loading">
                        <div class="topology-loading">
                            <div class="spinner"></div>
                            <p class="mt-3">Loading network topology...</p>
                        </div>
                    </div>
                    <svg id="network-svg" width="100%" height="100%" style="display: none;"></svg>
                    
                    <!-- Right Side Legend -->
                    <div class="topology-legend-right">
                        <h6 class="legend-title">Device Types</h6>
                        <div class="legend-items-vertical">
                            <div class="legend-item-right">
                                <div class="legend-icon device-switch">üîÄ</div>
                                <span>Switch</span>
                            </div>
                            <div class="legend-item-right">
                                <div class="legend-icon device-router">üåê</div>
                                <span>Router</span>
                            </div>
                            <div class="legend-item-right">
                                <div class="legend-icon device-server">üñ•Ô∏è</div>
                                <span>Server</span>
                            </div>
                            <div class="legend-item-right">
                                <div class="legend-icon device-firewall">üõ°Ô∏è</div>
                                <span>Firewall</span>
                            </div>
                            <div class="legend-item-right">
                                <div class="legend-icon device-wireless">üì∂</div>
                                <span>Wireless</span>
                            </div>
                            <div class="legend-item-right">
                                <div class="legend-icon device-unknown">‚ùì</div>
                                <span>Unknown</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Enhanced Network Topology Visualization...');
    
    const svg = d3.select('#network-svg');
    const container = document.getElementById('topology-container');
    const width = container.clientWidth;
    const height = container.clientHeight;
    
    let showLabels = true;
    let currentTransform = d3.zoomIdentity;
    
    svg.attr('viewBox', `0 0 ${width} ${height}`);
    
    // Add zoom behavior
    const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
            currentTransform = event.transform;
            g.attr('transform', event.transform);
        });
    
    svg.call(zoom);
    
    const g = svg.append('g');
    
    try {
        // Get data from Django template - enhanced error handling
        const rawData = '{{ topology_data_json|escapejs }}';
        console.log('Raw data received:', rawData ? 'Data loaded' : 'No data');
        
        if (!rawData || rawData.length < 10) {
            throw new Error('No topology data available from NetBox');
        }
        
        const topologyData = JSON.parse(rawData);
        console.log('Topology data parsed successfully:', topologyData);
        
        if (!topologyData.devices || topologyData.devices.length === 0) {
            throw new Error('No devices found in NetBox. Please add some devices first.');
        }
        
        console.log(`Loaded ${topologyData.devices.length} devices and ${topologyData.connections?.length || 0} connections`);
        
        createVisualization(topologyData);
        
    } catch (error) {
        console.error('Error loading topology:', error);
        showError(error.message);
    }
    
    function createVisualization(data) {
        // Convert devices to D3 nodes with enhanced properties
        const nodes = data.devices.map(device => ({
            id: device.id,
            name: device.name,
            type: getDeviceTypeFromDevice(device),
            site: device.site.name,
            role: device.role,
            status: device.status,
            deviceType: device.device_type.model,
            manufacturer: device.device_type.manufacturer,
            interfaceCount: device.interface_count || 0,
            x: Math.random() * (width - 100) + 50,
            y: Math.random() * (height - 100) + 50
        }));
        
        // Create links from connections data - only show REAL connections
        let links = [];
        if (data.connections && data.connections.length > 0) {
            // Use real connection data only
            links = data.connections
                .filter(conn => conn.a_device && conn.b_device)
                .map(conn => {
                    const source = nodes.find(n => n.id === conn.a_device);
                    const target = nodes.find(n => n.id === conn.b_device);
                    if (source && target) {
                        return {
                            source: source,
                            target: target,
                            type: conn.type,
                            status: conn.status,
                            length: conn.length
                        };
                    }
                    return null;
                }).filter(link => link !== null);
        }
        
        console.log(`Created visualization with ${nodes.length} nodes and ${links.length} real connections`);
        
        // If no connections, show a message
        if (links.length === 0) {
            console.log('No physical connections found - devices will be displayed without connections');
        }
        
        console.log(`Created visualization with ${nodes.length} nodes and ${links.length} links`);
        
        // Create force simulation with improved forces
        const simulation = d3.forceSimulation(nodes)
            .force('link', d3.forceLink(links).id(d => d.id).distance(100).strength(0.5))
            .force('charge', d3.forceManyBody().strength(-300).distanceMax(400))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(25))
            .force('x', d3.forceX(width / 2).strength(0.1))
            .force('y', d3.forceY(height / 2).strength(0.1));
        
        // Draw connections
        const linkGroup = g.append('g').attr('class', 'links');
        const linkElements = linkGroup
            .selectAll('line')
            .data(links)
            .enter()
            .append('line')
            .attr('class', 'connection-line')
            .attr('stroke', '#495057')
            .attr('stroke-width', d => getConnectionWidth(d))
            .style('opacity', 0.7);
        
        // Draw enhanced nodes with professional styling
        const nodeGroup = g.append('g').attr('class', 'nodes');
        const nodeElements = nodeGroup
            .selectAll('g')
            .data(nodes)
            .enter()
            .append('g')
            .attr('class', 'device-node')
            .style('cursor', 'pointer');

        // Add gradients for each device type
        const defs = svg.append('defs');
        const deviceTypes = ['switch', 'router', 'server', 'firewall', 'wireless', 'unknown'];
        deviceTypes.forEach(type => {
            const gradient = defs.append('radialGradient')
                .attr('id', `gradient-${type}`)
                .attr('cx', '30%')
                .attr('cy', '30%');
            
            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', getNodeColor(type, 'light'));
            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', getNodeColor(type, 'dark'));
        });

        // Outer glow ring
        nodeElements.append('circle')
            .attr('class', 'device-glow')
            .attr('r', d => getNodeRadius(d) + 4)
            .style('fill', 'none')
            .style('stroke', d => getNodeColor(d.type, 'glow'))
            .style('stroke-width', 2)
            .style('opacity', 0.4)
            .style('filter', 'blur(2px)');

        // Main device circle with gradient
        nodeElements.append('circle')
            .attr('r', d => getNodeRadius(d))
            .attr('class', d => `device-circle device-${d.type}`)
            .style('fill', d => `url(#gradient-${d.type})`)
            .style('stroke', '#ffffff')
            .style('stroke-width', 3)
            .style('filter', 'drop-shadow(0 4px 8px rgba(0,0,0,0.25))');

        // Inner highlight for 3D effect
        nodeElements.append('circle')
            .attr('class', 'device-highlight')
            .attr('r', d => Math.max(getNodeRadius(d) - 8, 4))
            .attr('cx', -2)
            .attr('cy', -2)
            .style('fill', 'rgba(255,255,255,0.4)')
            .style('pointer-events', 'none');
        
        // Add device icons (text-based for now)
        nodeElements.append('text')
            .attr('class', 'device-icon')
            .attr('text-anchor', 'middle')
            .attr('dy', '0.35em')
            .attr('font-size', '16px')
            .attr('fill', 'white')
            .attr('font-weight', 'bold')
            .style('text-shadow', '1px 1px 2px rgba(0,0,0,0.5)')
            .text(d => getDeviceIcon(d.type));
        
        // Add labels
        const labelGroup = g.append('g').attr('class', 'labels');
        const labelElements = labelGroup
            .selectAll('g')
            .data(nodes)
            .enter()
            .append('g');
        
        // Label background with better styling
        labelElements.append('rect')
            .attr('class', 'device-label-background')
            .attr('width', d => Math.max(d.name.length * 8, 60))
            .attr('height', 18)
            .attr('x', d => -Math.max(d.name.length * 8, 60) / 2)
            .attr('y', -32)
            .attr('rx', 4)
            .style('fill', 'rgba(255, 255, 255, 0.95)')
            .style('stroke', 'rgba(0, 0, 0, 0.2)')
            .style('stroke-width', 1);

        // Label text with better readability
        labelElements.append('text')
            .attr('class', 'device-label')
            .text(d => d.name.length > 15 ? d.name.substring(0, 15) + '...' : d.name)
            .attr('y', -24)
            .attr('text-anchor', 'middle')
            .style('font-family', 'Arial, sans-serif')
            .style('font-size', '11px')
            .style('font-weight', '600')
            .style('fill', '#333')
            .style('pointer-events', 'none');

        // Add device type label
        labelElements.append('text')
            .attr('class', 'device-type-label')
            .text(d => d.type.charAt(0).toUpperCase() + d.type.slice(1))
            .attr('y', -12)
            .attr('text-anchor', 'middle')
            .style('font-family', 'Arial, sans-serif')
            .style('font-size', '9px')
            .style('font-weight', '500')
            .style('fill', '#666')
            .style('pointer-events', 'none');        // Update positions on simulation tick
        simulation.on('tick', () => {
            linkElements
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);
            
            nodeElements.attr('transform', d => `translate(${d.x},${d.y})`);
            labelElements.attr('transform', d => `translate(${d.x},${d.y})`);
        });
        
        // Add enhanced drag behavior
        nodeElements.call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));
        
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
            d3.select(this).select('circle').attr('stroke-width', 4);
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
            d3.select(this).select('circle').attr('stroke-width', 2);
        }
        
        // Enhanced tooltips with better formatting
        nodeElements
            .on('mouseover', function(event, d) {
                showTooltip(event, d);
                d3.select(this).select('circle').classed('selected', true);
                // Highlight connected nodes
                links.forEach(link => {
                    if (link.source.id === d.id || link.target.id === d.id) {
                        d3.select(`#link-${link.source.id}-${link.target.id}`).style('stroke', '#ffc107').style('stroke-width', 3);
                    }
                });
            })
            .on('mouseout', function(event, d) {
                hideTooltip();
                d3.select(this).select('circle').classed('selected', false);
                // Reset highlighted connections
                d3.selectAll('.connection-line').style('stroke', '#495057').style('stroke-width', 2);
            })
            .on('click', function(event, d) {
                console.log('Clicked device:', d);
                // Could add device detail modal here
            });
        
        // Control buttons
        document.getElementById('refresh-btn').addEventListener('click', () => {
            location.reload();
        });
        
        document.getElementById('zoom-fit-btn').addEventListener('click', () => {
            const bounds = g.node().getBBox();
            const fullWidth = width;
            const fullHeight = height;
            const widthScale = fullWidth / bounds.width;
            const heightScale = fullHeight / bounds.height;
            const scale = Math.min(widthScale, heightScale) * 0.9;
            const translate = [
                (fullWidth - bounds.width * scale) / 2 - bounds.x * scale,
                (fullHeight - bounds.height * scale) / 2 - bounds.y * scale
            ];
            
            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        });

        // Zoom In button
        document.getElementById('zoom-in-btn').addEventListener('click', () => {
            svg.transition().duration(300).call(zoom.scaleBy, 1.5);
        });

        // Zoom Out button  
        document.getElementById('zoom-out-btn').addEventListener('click', () => {
            svg.transition().duration(300).call(zoom.scaleBy, 0.75);
        });

        // Toggle Labels button
        document.getElementById('toggle-labels-btn').addEventListener('click', () => {
            const labels = d3.selectAll('.labels');
            const isVisible = labels.style('opacity') !== '0';
            labels.transition().duration(300).style('opacity', isVisible ? 0 : 1);
        });
        
        document.getElementById('toggle-labels-btn').addEventListener('click', () => {
            showLabels = !showLabels;
            labelElements.style('display', showLabels ? 'block' : 'none');
            document.getElementById('toggle-labels-btn').innerHTML = 
                showLabels ? '<i class="mdi mdi-label"></i> Labels' : '<i class="mdi mdi-label-off"></i> Labels';
        });
        
        // Show visualization
        d3.select('#loading').style('display', 'none');
        svg.style('display', 'block');
        
        console.log('Network topology visualization loaded successfully!');
    }
    
    function showTooltip(event, device) {
        const tooltip = d3.select('body').append('div')
            .attr('class', 'topology-tooltip')
            .style('opacity', 0);
        
        tooltip.html(`
            <div class="tooltip-header">
                <h6>${getDeviceIcon(device.type)} ${device.name}</h6>
            </div>
            <div class="tooltip-body">
                <div class="tooltip-detail">
                    <span class="label">Type:</span>
                    <span class="value">${device.type.charAt(0).toUpperCase() + device.type.slice(1)}</span>
                </div>
                <div class="tooltip-detail">
                    <span class="label">Model:</span>
                    <span class="value">${device.deviceType || 'Unknown'}</span>
                </div>
                <div class="tooltip-detail">
                    <span class="label">Manufacturer:</span>
                    <span class="value">${device.manufacturer || 'Unknown'}</span>
                </div>
                <div class="tooltip-detail">
                    <span class="label">Site:</span>
                    <span class="value">${device.site}</span>
                </div>
                <div class="tooltip-detail">
                    <span class="label">Role:</span>
                    <span class="value">${device.role || 'Unknown'}</span>
                </div>
                <div class="tooltip-detail">
                    <span class="label">Status:</span>
                    <span class="value status-${device.status}">${device.status}</span>
                </div>
                <div class="tooltip-detail">
                    <span class="label">Interfaces:</span>
                    <span class="value">${device.interfaceCount}</span>
                </div>
            </div>
        `);
        
        tooltip.transition()
            .duration(200)
            .style('opacity', 1)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 10) + 'px');
    }
    
    function hideTooltip() {
        d3.selectAll('.topology-tooltip').remove();
    }
    
    function showError(message) {
        d3.select('#loading').html(`
            <div class="text-center">
                <i class="mdi mdi-alert-circle" style="font-size: 48px; color: #dc3545;"></i>
                <h5 class="mt-3 text-danger">Visualization Error</h5>
                <p class="text-muted">${message}</p>
                <p class="text-muted">Make sure you have devices configured in NetBox.</p>
                <button class="btn btn-primary" onclick="location.reload()">Reload</button>
            </div>
        `);
    }
    
    // Helper functions
    function getDeviceTypeFromDevice(device) {
        // First try device model
        const modelLower = (device.device_type?.model || '').toLowerCase();
        if (modelLower.includes('switch') || modelLower.includes('catalyst') || modelLower.includes('nexus') || modelLower.includes('sw-')) return 'switch';
        if (modelLower.includes('router') || modelLower.includes('isr') || modelLower.includes('mx') || modelLower.includes('asr') || modelLower.includes('rt-')) return 'router';
        if (modelLower.includes('server') || modelLower.includes('poweredge') || modelLower.includes('proliant') || modelLower.includes('srv-')) return 'server';
        if (modelLower.includes('firewall') || modelLower.includes('pa-') || modelLower.includes('asa') || modelLower.includes('fw-')) return 'firewall';
        if (modelLower.includes('access point') || modelLower.includes('ap-') || modelLower.includes('wireless')) return 'wireless';
        
        // Fallback to device role
        const roleLower = (device.role || '').toLowerCase();
        if (roleLower.includes('switch') || roleLower.includes('access') || roleLower.includes('distribution') || roleLower.includes('core')) return 'switch';
        if (roleLower.includes('router') || roleLower.includes('gateway') || roleLower.includes('edge')) return 'router';
        if (roleLower.includes('server') || roleLower.includes('host') || roleLower.includes('compute')) return 'server';
        if (roleLower.includes('firewall') || roleLower.includes('security') || roleLower.includes('utm')) return 'firewall';
        if (roleLower.includes('wireless') || roleLower.includes('wifi') || roleLower.includes('ap')) return 'wireless';
        
        return 'unknown';
    }
    
    function getDeviceType(model) {
        const modelLower = (model || '').toLowerCase();
        if (modelLower.includes('switch') || modelLower.includes('catalyst') || modelLower.includes('nexus') || modelLower.includes('sw-')) return 'switch';
        if (modelLower.includes('router') || modelLower.includes('isr') || modelLower.includes('mx') || modelLower.includes('asr') || modelLower.includes('rt-')) return 'router';
        if (modelLower.includes('server') || modelLower.includes('poweredge') || modelLower.includes('proliant') || modelLower.includes('srv-')) return 'server';
        if (modelLower.includes('firewall') || modelLower.includes('pa-') || modelLower.includes('asa') || modelLower.includes('fw-')) return 'firewall';
        if (modelLower.includes('access point') || modelLower.includes('ap-') || modelLower.includes('wireless')) return 'wireless';
        // Try to detect by device role as fallback
        return 'unknown';
    }
    
    function getDeviceIcon(type) {
        const icons = {
            'switch': 'üîÄ',      // Better switch icon
            'router': 'üåê', 
            'server': 'ÔøΩÔ∏è',     // Better server icon
            'firewall': 'üõ°Ô∏è',
            'wireless': 'ÔøΩ',   // Better wireless icon
            'unknown': '‚ùì'
        };
        return icons[type] || icons.unknown;
    }
    
    function getNodeRadius(device) {
        const baseRadius = 20;
        const interfaceBonus = Math.min(device.interfaceCount * 2, 10);
        return baseRadius + interfaceBonus;
    }
    
    function getNodeColor(type, variant = 'base') {
        const colors = {
            'switch': {
                'light': '#4a90e2',
                'dark': '#2c5aa0',
                'glow': '#6bb6ff',
                'base': '#0066cc'
            },
            'router': {
                'light': '#e74c3c',
                'dark': '#c0392b',
                'glow': '#ff6b6b',
                'base': '#cc3300'
            },
            'server': {
                'light': '#2ecc71',
                'dark': '#27ae60',
                'glow': '#58d68d',
                'base': '#339933'
            },
            'firewall': {
                'light': '#f39c12',
                'dark': '#e67e22',
                'glow': '#f8c471',
                'base': '#ff6600'
            },
            'wireless': {
                'light': '#9b59b6',
                'dark': '#8e44ad',
                'glow': '#bb8fce',
                'base': '#9933cc'
            },
            'unknown': {
                'light': '#95a5a6',
                'dark': '#7f8c8d',
                'glow': '#bdc3c7',
                'base': '#666666'
            }
        };
        
        return colors[type] ? colors[type][variant] : colors.unknown[variant];
    }
    
    function getConnectionWidth(link) {
        if (link.status === 'connected') return 2;
        if (link.status === 'planned') return 1;
        return 1;
    }
});
</script>
{% endblock %}
